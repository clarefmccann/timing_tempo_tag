---
title: "deriving timing & tempo"
author: "cfm"
date: "`r Sys.Date()`"
output:
  html_document:
    code_folding: hide
    df_print: paged
    highlight: tango
    theme: united
    toc: yes
    toc_float:
      collapsed: yes
      smooth_scroll: yes
  pdf_document:
    toc: yes
---

### setting up markdown {.tabset}

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = TRUE,
	message = TRUE,
	warning = TRUE
)

options(scipen=999)
```

### loading required packages

```{r load Required Packages, message=FALSE, warning=FALSE, include=FALSE}
# load packages
library(pacman)
pacman::p_load(dplyr, lme4, nlme, ggplot2, tidyr, lubridate, psych, saemix, lavaan, here, install = TRUE)
```

### setting root path

```{r root path}


cas_dir <- Sys.getenv("CAS_DIR")
proj_root <-  here()
data_root <- paste0(cas_dir, "/TAG/data/Qualtrics_Output/Long/")


## UPDATE FILE NAMES IF NEEDED

pds_file_name = "PDS_AllObs_Chronological.csv"
pbip_file_name = "PBIP_AllObs_Chronological.csv"
age_file_name = "sample_ages_13feb26.csv"
pub_comp_file_name = "Allwaves_PubertyComposite_updated.csv"

```

### loading in data  

```{r loading in data}

## for puberty self-report variables

pds <- read.csv(paste0(data_root, pds_file_name)) %>% 
  mutate(tagid=as.factor(tagid),
         wave=as.factor(wave)) %>%
  rename("adrenal_pdss" = "adrenf2",
         "gonadal_pdss" = "gonadf2") %>% 
  select(tagid, wave, adrenal_pdss, gonadal_pdss, pdss)
pbip <- read.csv(paste0(data_root, pbip_file_name)) %>% 
  select(tagid, wave, stage, PBIP_2A, PBIP_1A) %>% 
  mutate(tagid=as.factor(tagid),
         wave=as.factor(wave)) %>%
  rename("adrenal_pbip" = "PBIP_2A",
         "gonadal_pbip" = "PBIP_1A") %>% 
  select(tagid, wave, adrenal_pbip, gonadal_pbip)
comp <- read.csv(paste0(data_root, pub_comp_file_name)) %>% 
  mutate(tagid=as.factor(tagid),
         wave=as.factor(wave)) %>%
  select(tagid, wave, ADRENcomp, GONADcomp, PUBcomp)

age <- read.csv(paste0(cas_dir, "/TAG/data/Demographics/", age_file_name)) %>% 
  pivot_longer(cols = 2:14, names_to = "wave", values_to = "age") %>%
  filter(
    !wave == "w1s1_age",
    !wave == "w2s1_age",
    !wave == "w3s1_age",
    !wave == "w4s1_age",
    !wave == "w5s1_age",
    !wave == "w6s1_age"
  ) %>%
  mutate(
    wave = ifelse(wave == "w1s2_age", "1",
                  ifelse(wave == "w2s2_age", "2",
                         ifelse(wave == "w3s2_age", "3",
                                ifelse(wave == "w4s2_age", "4",
                                       ifelse(wave == "w5s2_age", "5",
                                              ifelse(wave == "w6s2_age", "6",
                                                     ifelse(wave == "sos_age", "SOS",
                                              wave)))))))) %>%
  filter(!is.na(age))

puberty_sr <- left_join(pds, pbip, by = c("tagid", "wave"))
puberty_sr <- left_join(puberty_sr, comp, by = c("tagid", "wave"))
puberty_sr <- left_join(puberty_sr, age, by = c("tagid", "wave"))

rm(age, comp, pbip, pds, age_file_name, pbip_file_name, pub_comp_file_name, pds_file_name)

```

```{r option to remove regressors}

## REMOVE REGRESSING CASES

### CHANGE PUBERTY VAR TO VARIABLE OF INTEREST

regressing_ids <- puberty_sr %>%
  arrange(tagid, wave) %>%
  group_by(tagid) %>%
  mutate(stage_diff = stage - lag(stage)) %>%
  filter(stage_diff < 0) %>%
  select(tagid) %>%
  distinct()

# puberty_sr <- puberty_sr %>% 
#   filter(!(tagid %in% regressing_ids$tagid))

```

## mean plots 

```{r plots means}

# add color for wave

### STAGE / SUMMARY

print("mean pdss at each wave")

pdss_means <- puberty_sr %>%
  filter(!is.na(pdss)) %>%
  group_by(wave) %>%
  summarize(mean = mean(pdss))

plot(pdss_means, ylim=c(1,5), 
     xlab = "wave",
     ylab = "PDSS",
     main = "plot of means overtime (PDSS)",
     pch = 16)

print("mean stage (PBIP) score at each wave")

stage_means <- puberty_sr %>%
  filter(!is.na(stage)) %>%
  group_by(wave) %>%
  summarize(mean = mean(stage))

plot(stage_means, ylim=c(1,5), 
     xlab = "wave",
     ylab = "stage (pbip)",
     main = "plot of means overtime (PBIP - stage)",
     pch = 16)

print("mean PUBcomp score at each wave")

PUBcomp_means <- puberty_sr %>%
  filter(!is.na(PUBcomp)) %>%
  group_by(wave) %>%
  summarize(mean = mean(PUBcomp))

plot(PUBcomp_means, ylim=c(1,5), 
     xlab = "wave",
     ylab = "pubcomp",
     main = "plot of means overtime (pubcomp)",
     pch = 16)

print("mean pdss adrenal score at each wave")

### ADRENAL 

pdss_adren_means <- puberty_sr %>%
  filter(!is.na(adrenal_pdss)) %>%
  group_by(wave) %>%
  summarize(mean = mean(adrenal_pdss))

plot(pdss_adren_means, ylim=c(1,5), 
     xlab = "wave",
     ylab = "adrenal pdss",
     main = "plot of pdss adrenal means overtime",
     pch = 16)

print("mean pbip adrenal score at each wave")

pbip_adrenal_means <- puberty_sr %>%
  filter(!is.na(gonadal_pbip)) %>%
  group_by(wave) %>%
  summarize(mean = mean(gonadal_pbip))

plot(pbip_adrenal_means, ylim=c(1,5), 
     xlab = "wave",
     ylab = "adrenal pbip",
     main = "plot of pbip adrenal means overtime",
     pch = 16)

print("mean pubcomp adrenal score at each wave")

pubcomp_adrenal_means <- puberty_sr %>%
  filter(!is.na(ADRENcomp)) %>%
  group_by(wave) %>%
  summarize(mean = mean(ADRENcomp))

plot(pubcomp_adrenal_means, ylim=c(1,5), 
     xlab = "wave",
     ylab = "pubcomp adrenal",
     main = "plot of comp adrenal means overtime",
     pch = 16)

### GONADAL 

print("mean pdss gonadal score at each wave")

pdss_gonad_means <- puberty_sr %>%
  filter(!is.na(gonadal_pdss)) %>%
  group_by(wave) %>%
  summarize(mean = mean(gonadal_pdss))

plot(pdss_gonad_means, ylim=c(1,5), 
     xlab = "wave",
     ylab = "gonadal PDSS",
     main = "plot of pdss gonadal means overtime",
     pch = 16)

print("mean pbip gonadal score at each wave")

pbip_gonad_means <- puberty_sr %>%
  filter(!is.na(gonadal_pbip)) %>%
  group_by(wave) %>%
  summarize(mean = mean(gonadal_pbip))

plot(pbip_gonad_means, ylim=c(1,5), 
     xlab = "wave",
     ylab = "gonadal pbip",
     main = "plot of pbip gonadal means overtime",
     pch = 16)


print("mean comp gonadal score at each wave")

pubcomp_gonad_means <- puberty_sr %>%
  filter(!is.na(GONADcomp)) %>%
  group_by(wave) %>%
  summarize(mean = mean(gonadal_pbip))

plot(pubcomp_gonad_means, ylim=c(1,5), 
     xlab = "wave",
     ylab = "pubcomp gonadal",
     main = "plot of pubcomp gonadal means overtime",
     pch = 16)



adrenal_cor_vars <- puberty_sr[, c("adrenal_pdss", "adrenal_pbip", "ADRENcomp")]
print("printing adrenal cor matrix")
print(cor(adrenal_cor_vars, use = "pairwise.complete.obs"))

gonadal_cor_vars <- puberty_sr[, c("gonadal_pdss", "gonadal_pbip", "GONADcomp")]
print("printing gonadal cor matrix")
print(cor(gonadal_cor_vars, use = "pairwise.complete.obs"))

total_cor_vars <- puberty_sr[, c("pdss", "stage", "PUBcomp")]
print("printing total cor matrix")
print(cor(total_cor_vars, use = "pairwise.complete.obs"))



```

## observed avg age at TS3 for different measures

```{r obs TS3}

str(puberty_sr)
puberty_sr$tagid <- as.factor(puberty_sr$tagid)

## means and stuff for stages and things 

print("observed first instance for age at TS3 by pdss")

pdss_avg_age_ts3 <- puberty_sr %>%
  filter(pdss == 3) %>%              
  group_by(tagid) %>%                     
  slice_min(order_by = age, n = 1, with_ties = FALSE) %>% 
  ungroup() %>%                                 
  summarize(average_age = mean(age, na.rm = TRUE),
            min_age = min(age, na.rm = TRUE),
            max_age = max(age, na.rm = TRUE),
            n_participants = n_distinct(tagid))

print(pdss_avg_age_ts3) 

print("observed first instance for age at TS3 by stage (PBIP)")

stage_avg_age_ts3 <- puberty_sr %>%
  filter(stage == 3) %>%              
  group_by(tagid) %>%                     
  slice_min(order_by = age, n = 1, with_ties = FALSE) %>% 
  ungroup() %>%                                 
  summarize(average_age = mean(age, na.rm = TRUE),
            min_age = min(age, na.rm = TRUE),
            max_age = max(age, na.rm = TRUE),
            n_participants = n_distinct(tagid))

print(stage_avg_age_ts3)

print("observed first instance for age at TS3 by pubcomp")

pubcomp_avg_age_ts3 <- puberty_sr %>%
  filter(PUBcomp == 3) %>%              
  group_by(tagid) %>%                     
  slice_min(order_by = age, n = 1, with_ties = FALSE) %>% 
  ungroup() %>%                                 
  summarize(average_age = mean(age, na.rm = TRUE),
            min_age = min(age, na.rm = TRUE),
            max_age = max(age, na.rm = TRUE),
            n_participants = n_distinct(tagid))

print(pubcomp_avg_age_ts3) 

print("observed first instance for age at TS3 by PDSS adrenal score")

pdss_adrenal_avg_age_ts3 <- puberty_sr %>%
  filter(adrenal_pdss == 3) %>%              
  group_by(tagid) %>%                     
  slice_min(order_by = age, n = 1, with_ties = FALSE) %>% 
  ungroup() %>%                                 
  summarize(average_age = mean(age, na.rm = TRUE),
            min_age = min(age, na.rm = TRUE),
            max_age = max(age, na.rm = TRUE),
            n_participants = n_distinct(tagid))

print(pdss_adrenal_avg_age_ts3) 

print("observed first instance for age at TS3 by pbip adrenal score")

pbip_adrenal_avg_age_ts3 <- puberty_sr %>%
  filter(adrenal_pbip == 3) %>%              
  group_by(tagid) %>%                     
  slice_min(order_by = age, n = 1, with_ties = FALSE) %>% 
  ungroup() %>%                                 
  summarize(average_age = mean(age, na.rm = TRUE),
            min_age = min(age, na.rm = TRUE),
            max_age = max(age, na.rm = TRUE),
            n_participants = n_distinct(tagid))

print(pbip_adrenal_avg_age_ts3) 

print("observed first instance for age at TS3 by pubcomp adrenal score")

pubcomp_adrenal_avg_age_ts3 <- puberty_sr %>%
  filter(ADRENcomp == 3) %>%              
  group_by(tagid) %>%                     
  slice_min(order_by = age, n = 1, with_ties = FALSE) %>% 
  ungroup() %>%                                 
  summarize(average_age = mean(age, na.rm = TRUE),
            min_age = min(age, na.rm = TRUE),
            max_age = max(age, na.rm = TRUE),
            n_participants = n_distinct(tagid))

print(pubcomp_adrenal_avg_age_ts3) 

print("observed first instance for age at TS3 by PDSS gonadal score")

pdss_gonadal_avg_age_ts3 <- puberty_sr %>%
  filter(gonadal_pdss == 3) %>%              
  group_by(tagid) %>%                     
  slice_min(order_by = age, n = 1, with_ties = FALSE) %>% 
  ungroup() %>%                                 
  summarize(average_age = mean(age, na.rm = TRUE),
            min_age = min(age, na.rm = TRUE),
            max_age = max(age, na.rm = TRUE),
            n_participants = n_distinct(tagid))

print(pdss_gonadal_avg_age_ts3)

print("observed first instance for age at TS3 by pubcomp gonadal score")

pubcomp_gonadal_avg_age_ts3 <- puberty_sr %>%
  filter(GONADcomp == 3) %>%              
  group_by(tagid) %>%                     
  slice_min(order_by = age, n = 1, with_ties = FALSE) %>% 
  ungroup() %>%                                 
  summarize(average_age = mean(age, na.rm = TRUE),
            min_age = min(age, na.rm = TRUE),
            max_age = max(age, na.rm = TRUE),
            n_participants = n_distinct(tagid))

print(pubcomp_gonadal_avg_age_ts3)

```

## viewing the raw data 
```{r viewing raw data}

## visualizing observations

print("observed PDSS trajectories")

ggplot(puberty_sr, aes(x = age, y = pdss)) +
  geom_point() +
  geom_smooth(method = "loess")

print("observed stage (PBIP) trajectories")

ggplot(puberty_sr, aes(x = age, y = stage)) +
  geom_point() +
  geom_smooth(method = "loess")

print("observed pubcomp trajectories")

ggplot(puberty_sr, aes(x = age, y = PUBcomp)) +
  geom_point() +
  geom_smooth(method = "loess")

print("observed pdss adrenal trajectories")

ggplot(puberty_sr, aes(x = age, y = adrenal_pdss)) +
  geom_point() +
  geom_smooth(method = "loess")

print("observed pbip adrenal trajectories")

ggplot(puberty_sr, aes(x = age, y = adrenal_pbip)) +
  geom_point() +
  geom_smooth(method = "loess")

print("observed pubcomp adrenal trajectories")

ggplot(puberty_sr, aes(x = age, y = ADRENcomp)) +
  geom_point() +
  geom_smooth(method = "loess")

print("observed pdss gonadal trajectories")

ggplot(puberty_sr, aes(x = age, y = gonadal_pdss)) +
  geom_point() +
  geom_smooth(method = "loess")

print("observed pbip gonadal trajectories")

ggplot(puberty_sr, aes(x = age, y = gonadal_pbip)) +
  geom_point() +
  geom_smooth(method = "loess")

print("observed pubcomp gonadal trajectories")

ggplot(puberty_sr, aes(x = age, y = GONADcomp)) +
  geom_point() +
  geom_smooth(method = "loess")


```

## data preparation

```{r data preparation}

## getting a better idea of the data we have 

obs_per_participant <- puberty_sr %>%
  group_by(tagid) %>%
  summarise(observations = n()) %>%
  ungroup()

obs_distribution <- obs_per_participant %>%
  group_by(observations) %>%
  summarise(participants_count = n())

print(obs_distribution)

## creating a mean centered age variable but right now the model is using original age which i think is what we want, right? 

puberty_sr <- puberty_sr %>% 
  filter(!is.na(age) & !is.na(tagid)) %>% 
  mutate(age_cen = age - mean(age))

```

## THE LOOP 

```{r the loop}

### choose what variables you want to use

set.seed(90025)

print("interpretation of values: lambda is timing (or age at peak growth / TS3), alpha is tempo (or rate of change)")
print("smaller or more negative values for for lambda = earlier timing, positive or larger values for alpha = faster tempo")

puberty_vars <- c("pdss", "stage", "adrenal_pbip", "PUBcomp","GONADcomp", "gonadal_pbip")
## model does not converge with PDSS or PUBcomp adrenal scores, or PDSS gonadal score

# logistic model with random effects
logistic_model <- function(age, b0, b1, alpha, lambda) {
  b0 + (b1 - b0) * (1 / (1 + exp(-alpha * (age - lambda))))
}

start_vals <- list(fixed = c(alpha = 0.95, lambda = 13.1))

results_list <- list()

for (var in puberty_vars) {
  print(paste0("fitting model for: ", var))
  
  puberty_sr_tmp <- puberty_sr %>%
    rename(puberty = !!sym(var)) %>%
    filter(!is.na(puberty) & !is.na(age) & !is.na(tagid))

  fit <- nlme(puberty ~ logistic_model(age, 1, 5, alpha, lambda),
              data = puberty_sr_tmp,
              fixed = alpha + lambda ~ 1,
              random = pdDiag(alpha + lambda ~ 1),
              groups = ~ tagid,
              start = start_vals,
              method = "ML")

  fitted_values <- fitted(fit)
  individual_estimates <- ranef(fit)
  individual_estimates_df <- data.frame(id = rownames(individual_estimates), individual_estimates) %>%
    rename("tagid" = "id")
  
  puberty_plot <- cbind(fitted_values, puberty_sr_tmp)
  puberty_plot <- left_join(puberty_plot, individual_estimates_df, by = "tagid")
  
  fitted_values_plot <- ggplot(data = puberty_plot, aes(x = age, y = fitted_values, color = tagid)) +
    geom_point(aes(y = fitted_values), size = 1, shape = 16) +  
    geom_line(aes(y = fitted_values), size = 0.5, linetype = "solid") +
    labs(
      title = paste("predicted values -", var),
      x = "age",
      y = "predicted pubertal stage",
      color = "tagid"
    ) +
    theme_minimal() +
    theme(legend.position = "none")
  
  print(paste0("printing fitted values plot for", var))
  
  print(fitted_values_plot)
  
  results_list[[var]] <- list(
    fit = fit,
    fitted_values = fitted_values,
    individual_estimates = individual_estimates,
    plot = fitted_values_plot
  )
  
  
  # write.csv(puberty_wide, paste0("puberty_wide_", var, ".csv"))
  # write.csv(puberty_plot, paste0("puberty_plot_", var, ".csv"))
}

all_estimates <- NULL

for (var in names(results_list)) {
  estimates <- results_list[[var]]$individual_estimates
  estimates_df <- data.frame(tagid = rownames(estimates), estimates, row.names = NULL)
  
  colnames(estimates_df)[-1] <- paste0(var, "_", colnames(estimates_df)[-1])
  
  if (is.null(all_estimates)) {
    all_estimates <- estimates_df
  } else {
    all_estimates <- full_join(all_estimates, estimates_df, by = "tagid")
  }
}


write.csv(all_estimates, paste0(proj_root, "TAG_timing_tempo_04.2025.csv"), row.names = FALSE)


```

#### testing different lambda and alpha start values 

```{r testing diff lambda & alpha}

##### CHANGE IN STARTING VALUES DID NOT SIGNIFICANTLY IMPACT MODEL FIT OR ESTIMATES

# set.seed(12000)
# 
# ### remove a few observations and see if results hold 
# 
# logistic_model <- function(age, b0, b1, alpha, lambda) {
# b0 + (b1 - b0) * (1 / (1 + exp(-alpha * (age - lambda)))) }
# 
# 
# fit_logistic_model <- function(data, alpha_start, lambda_start) {
# 
#   start_vals <- list(fixed = c(alpha = alpha_start, lambda = lambda_start))
#   
# 
#   fit <- tryCatch(
#     {
#       nlme(
#         pdss ~ logistic_model(age, 1, 5, alpha, lambda),
#         data = puberty_sr,
#         fixed = alpha + lambda ~ 1,
#         random = pdDiag(alpha + lambda ~ 1),
#         groups = ~ tagid,
#         start = start_vals,
#         method = "ML"
#       )
#     },
#     error = function(e) NULL
#   )
#   
#   return(fit)
# }
# 
# 
# ## played around with a few different ranges, the model seems to be sensitive to this (won't converge if the range is too big)
# alpha_range <- seq(0.7, 1.0, by = 0.05)
# lambda_range <- seq(12, 13.5, by = 0.1) 
# 
# 
# results <- data.frame(
#   alpha = numeric(),
#   lambda = numeric(),
#   logLik = numeric(),  
#   AIC = numeric(),     
#   BIC = numeric()     
# )
# 
# 
# for (alpha_val in alpha_range) {
#   for (lambda_val in lambda_range) {
#     fit <- fit_logistic_model(puberty_sr, alpha_val, lambda_val)
#     
#     if (!is.null(fit)) {
# 
#       results <- results %>%
#         add_row(
#           alpha = alpha_val,
#           lambda = lambda_val,
#           logLik = as.numeric(logLik(fit)),
#           AIC = AIC(fit),
#           BIC = BIC(fit)
#         )
#     }
#   }
# }
# 
# best_model <- results %>% arrange(AIC) %>% slice(1)
# 
# 
# print(results)
# 
# # best combination of alpha and lambda
# print(best_model) ## alpha = 0.95, lambda = 12.1 // now it's giving me a different combo, 0.95 and 13.1... i think its bcz i messed with the range of start values to try and added back in random slope bcz it was converging with the new range (i just made the range a bit smaller)






```

<!-- ## fixed log plot -->
<!-- ```{r fix log plot} -->
<!-- fixed_plot <- ggplot(puberty_sr, aes(x = age, y = stage, color = tagid)) + -->
<!--   geom_line(aes(y = fitted_values), linetype = "dashed") + -->
<!--   labs(title = "Fitted (Fixed) Logistic Growth Curves", -->
<!--        x = "Age", -->
<!--        y = "Pubertal Stage") + -->
<!--   theme_minimal()+ -->
<!--   theme(legend.position = "none") -->

<!-- print(fixed_plot) -->
<!-- ``` -->

<!-- ## ind log plot  -->

<!-- ```{r ind log plot} -->

<!-- ind_plot <- ggplot(puberty_sr, aes(x = age, y = stage, color = tagid)) + -->
<!--   geom_line(aes(y = predicted_stage_individual), linetype = "dashed") + -->
<!--   labs(title = "Fitted (Ind) Logistic Growth Curves", -->
<!--        x = "Age", -->
<!--        y = "Pubertal Stage") + -->
<!--   theme_minimal()+ -->
<!--   theme(legend.position = "none") -->

<!-- print(ind_plot) -->


<!-- ``` -->

<!-- ## OLD -->

<!-- ### linear growth model (lavaan) -->

<!-- ```{r lin} -->

<!-- ## option  -->

<!--  # # Residual variances fixed to be equal: -->
<!--               #  pub1 ~~ z*pub1 -->
<!--               #  pub2 ~~ z*pub2 -->
<!--               #  pub3 ~~ z*pub3 -->
<!--               #  pub4 ~~ z*pub4 -->
<!--               #  pub5 ~~ z*pub5 -->

<!-- ##### RUNNING LINEAR MODEL ##### -->
<!-- model_lin <- ' # Measurement model: -->
<!--                i =~ 1*pub1 + 1*pub2 + 1*pub3 + 1*pub4 + 1*pub5 -->
<!--                s =~ 0*pub1 + 1*pub2 + 2*pub3 + 3*pub4 + 4*pub5  ' -->
<!--   # specify the model -->

<!-- fit_model_lin <- growth(model_lin, data = puberty_wide, missing = "ML") -->
<!--   # fit linear model using 'growth' function in lavaan package -->
<!--   # missing = ML imputes missing values -->

<!-- summary(fit_model_lin) -->
<!--   # call summary of model to get parameter estimates -->

<!-- predict(fit_model_lin) -->

<!-- fitMeasures(fit_model_lin, c("aic", "bic")) -->
<!--   # fit statistics -->

<!-- ``` -->


<!-- ### latent basis model -->

<!-- ```{r latent basis} -->

<!-- ##### RUNNING LATENT BASIS MODEL ##### -->
<!-- model_latent <- ' # Measurement model: -->
<!--                   i =~ 1*pub1 + 1*pub2 + 1*pub3 + 1*pub4 + 1*pub5 -->
<!--                   s =~ 0*pub1 + a*pub2 + b*pub3 + c*pub4 + 1*pub5 ' -->
<!--   # specify the model -->
<!--   # fix first and last growth factors to 0 and 1, then use letters to allow other paths to vary freely -->

<!-- fit_model_latent <- growth(model_latent, data = puberty_wide, missing = "ML") -->

<!-- summary(fit_model_latent) -->

<!-- predict(fit_model_latent) -->

<!-- fitMeasures(fit_model_latent, c("aic", "bic")) -->
<!--   # fit statistics -->

<!-- ``` -->

<!-- ### quad model  -->

<!-- ```{r quad model} -->

<!-- ## option  -->
<!-- # # Residual variances fixed to be equal: -->
<!--                 #   pub1 ~~ z*pub1 -->
<!--                 #   pub2 ~~ z*pub2 -->
<!--                 #   pub3 ~~ z*pub3 -->
<!--                 #   pub4 ~~ z*pub4 -->
<!--                 #   pub5 ~~ z*pub5  -->

<!-- ##### RUNNING QUADRATIC MODEL ##### -->
<!-- model_quad <- ' # Measurement model: -->
<!--                 i =~ 1*pub1 + 1*pub2 + 1*pub3 + 1*pub4 + 1*pub5 -->
<!--                 s =~ 0*pub1 + 1*pub2 + 2*pub3 + 3*pub4 + 4*pub5 -->
<!--                 q =~ 0*pub1 + 1*pub2 + 4*pub3 + 9*pub4 + 16*pub5 ' -->

<!-- fit_model_quad <- growth(model_quad, data = puberty_wide, missing = "ML") -->

<!-- summary(fit_model_quad) -->

<!-- predict(fit_model_quad) -->

<!-- fitMeasures(fit_model_quad, c("aic", "bic")) -->
<!-- ``` -->

<!-- ### rel model -->

<!-- ```{r rel model} -->

<!-- ##### RUNNING RELATIVE MODEL ##### -->
<!-- model_rel <- ' # Measurement model: -->
<!--                 i =~ 1*pub1 + 1*pub2 + 1*pub3 + 1*pub4 + 1*pub5 -->
<!--                 s =~ 0*pub1 + pub2 + pub3 + pub4 + pub5 ' -->

<!-- fit_model_rel <- growth(model_rel, data = puberty_wide, missing = "ML") -->

<!-- summary(fit_model_rel) -->

<!-- ## extracting the slopes  -->

<!-- rel_pred <- predict(fit_model_rel) -->

<!-- fitMeasures(fit_model_rel, c("aic", "bic")) -->

<!-- ``` -->

=======
puberty_sr <- puberty_sr %>% 
  distinct(tagid, wave, .keep_all = TRUE) 
  
puberty_wide <- puberty_sr %>%
  select(tagid, wave, stage) %>%
  pivot_wider(names_from = "wave", values_from = "stage") %>%
  rename("pub1" = "1",
         "pub2" = "2",
         "pub3" = "3",
         "pub4" = "4",
         "pub5" = "5")
age_wide <- puberty_sr %>%
  select(tagid, wave, age) %>%
  pivot_wider(names_from = "wave", values_from = "age") %>%
  rename("age1" = "1",
         "age2" = "2",
         "age3" = "3",
         "age4" = "4",
         "age5" = "5")

puberty_wide <- full_join(puberty_wide, age_wide, by = "tagid")

## REMOVE REGRESSING CASES

# regressing_ids <- puberty_sr %>%
#   arrange(tagid, wave) %>%               
#   group_by(tagid) %>%                   
#   mutate(stage_diff = stage - lag(stage)) %>%  
#   filter(stage_diff < 0) %>%            
#   select(id) %>%                      
#   distinct()
# 
# puberty_sr <- puberty_sr %>% 
#   filter(!(tagid %in% regressing_ids$tagid))

```

## mean plots 

```{r plots means}

# add color for wave

means <- puberty_sr %>%
  filter(!is.na(stage)) %>%
  group_by(wave) %>%
  summarize(mean = mean(stage))
plot(means, ylim=c(1,5), 
     xlab = "Time",
     ylab = "Pubertal Status",
     main = "Plot of means for Pubertal Status",
     pch = 16)

puberty_sr %>% 
  ggplot(aes(age, stage, group = tagid)) +
  geom_line(alpha = 0.1) +                      
  stat_smooth(aes(group=1),                     
              method = "lm", formula = y ~ x + I(x^2), size = 1.5,
              level = 0.95,
              color = "blue") +
  theme_classic() +
  labs(x = "Age", y = "Pubertal Status", title = "Pubertal Status")

```

## anthr try at OG code 

```{r anthr try at OG code}

# logistic model with random effects
logistic_model <- function(age, b0, b1, alpha, lambda) {
b0 + (b1 - b0) * (1 / (1 + exp(-alpha * (age - lambda)))) }

# the starting values for the parameters

## we're saying 0.9 is the avg rate of pubertal dev & 13.5 is the avg age of mid-puberty 
start_vals <- list(fixed = c(alpha = 0.9, lambda = 13.5))

# removing NAs for now but there could be some sort of fancy way to deal with this
puberty_sr <- puberty_sr %>% 
  filter(!is.na(stage) & !is.na(age) & !is.na(tagid))

# fit THE nonlinear mixed effects model
## set lower asym at stage 1 and upper asym at stage 5, grouping by tagid
fit <- nlme(stage ~ logistic_model(age, 1, 5, alpha, lambda),
            data = puberty_sr,
            fixed = alpha + lambda ~ 1,
            random = pdDiag(alpha + lambda ~ 1),
            groups = ~ tagid,
            start = start_vals, method = "ML")

# the fitted values 
## predicted stage based on an individual's age
fitted_values <- fitted(fit)

# the individual parameter estimates 
## alpha = more pos values --> slower dev, more neg values --> faster dev
## lambda = more pos values --> later mid-pubertal peak, more neg values --> earlier mid-pubertal peak
individual_estimates <- ranef(fit)

# summary
summary(fit)

# individual estimates + wide
individual_estimates_df <- data.frame(id = rownames(individual_estimates), individual_estimates) %>% 
  rename("tagid" = "id")

puberty_wide <- left_join(puberty_wide, individual_estimates_df, by = "tagid")

write.csv(puberty_wide, file = "puberty_wide_plus_alpha_lambda.csv")

puberty_plot <- cbind(fitted_values, puberty_sr) 
puberty_plot <- left_join(puberty_plot, individual_estimates_df, by = "tagid")

#write.csv(puberty_plot, file = "puberty_long_plus_alpha_lambda.csv")

fitted_values_plot <- ggplot(data = puberty_plot, aes(x = age, y = fitted_values, color = tagid)) +
  geom_point(aes(y = fitted_values), size = 1, shape = 16) +  
  geom_line(aes(y = fitted_values), size = 0.5, linetype = "solid") +
  labs(
    title = "predicted values - log model",
    x = "age",
    y = "predicted pubertal stage",
    color = "tagid"
  ) +
  theme_minimal() +
  theme(legend.position = "none")

print(fitted_values_plot)


```
>>>>>>> e18315de4b052a9ead02773a98c8fae747ea21e1

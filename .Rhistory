options(digits=3)
###IMPORT TAG OVERVIEW DOC FROM CAS ######
overview <- read.xlsx(paste0(cas_dir,'behavior/Overview/Overview_Withdrawn_Completed/TAG_Overview_Doc.xlsx'),1)
overview <- overview[,c("TAG_ID","W1S2_Completed","Withdrawn_W1","Exclusionary_Withdrawl")]
#removing everyone who withdrew at W1 (exclusionary withdrawals) -- has anyone withdrawn their data recently??
overview <- overview %>%
mutate(Exclusionary_Withdrawl = replace_na(Exclusionary_Withdrawl, "0")) %>%
mutate(Withdrawn_W1 = replace_na(Withdrawn_W1, "0")) %>%
arrange(Exclusionary_Withdrawl) %>%
filter(Exclusionary_Withdrawl=="0") %>%
filter(Withdrawn_W1=="0") %>%
mutate(tagid=paste0("TAG",
substring(TAG_ID,first=5,last=length(TAG_ID))))
###### LOAD PDS, PBIP AND AGE  ######
#file_list_pds = Sys.glob(paste0(quest_dir, 'Wave*/PDS_Wave*.csv'))
#file_list_pbip = Sys.glob(paste0(quest_dir,'Wave*/PBIP_Wave*.csv'))
file_list_pds = Sys.glob(paste0(quest_dir, 'PDS_AllObs*.csv'))
file_list_pbip = Sys.glob(paste0(quest_dir,'PBIP_AllObs*.csv'))
print(file_list_pbip)
PDS = data.frame()
for (file in file_list_pds) {
temp <- read.table(file, header=TRUE, sep=",") %>%
select(tagid, adrenf2, gonadf2, pdss, survey_date) %>%
mutate(wave = regmatches(file, regexpr("[[:digit:]]+", file)))
PDS = rbind(PDS, temp)
rm(temp)
}
for (file in file_list_pds) {
temp <- read.table(file, header=TRUE, sep=",") %>%
select(tagid, adrenf2, gonadf2, pdss, survey_date) %>%
PDS = rbind(PDS, temp)
rm(temp)
}
for (file in file_list_pds) {
temp <- read.table(file, header=TRUE, sep=",") %>%
select(tagid, adrenf2, gonadf2, pdss, survey_date) %>%
PDS = rbind(PDS, temp)
rm(temp)
}
PDS <- read.csv(paste0(quest_dir, "PDS_AllObs_Chronological.csv"))
PDS <- read.csv(paste0(quest_dir, "PBIP_AllObs_Chronological.csv"))
PDS <- read.csv(paste0(quest_dir, "PDS_AllObs_Chronological.csv"))
PBIP <- read.csv(paste0(quest_dir, "PBIP_AllObs_Chronological.csv"))
View(PBIP)
View(PDS)
Age <- read.table(paste0(age_dir, "allwaves_age_long_06.13.2025.csv"), header = TRUE, sep = ",")
Allwaves_Puberty_Q <- full_join(PDS, PBIP,  by=c("tagid","wave"))
Allwaves_Puberty_Q <- Allwaves_Puberty_Q[!(Allwaves_Puberty_Q$tagid=="TAG077" & Allwaves_Puberty_Q$pdss==3.5 & Allwaves_Puberty_Q$stage==2),]
Allwaves_Puberty_Q <- Allwaves_Puberty_Q[!(Allwaves_Puberty_Q$tagid=="TAG077" & Allwaves_Puberty_Q$pdss==2 & Allwaves_Puberty_Q$stage==3),]
Allwaves_Puberty_Q$wave[Allwaves_Puberty_Q$tagid=="TAG077" & Allwaves_Puberty_Q$pdss==3.5 & Allwaves_Puberty_Q$stage==3] = 3
Allwaves_Puberty_Q <- Allwaves_Puberty_Q[!(Allwaves_Puberty_Q$tagid=="TAG124" & Allwaves_Puberty_Q$pdss==5 & Allwaves_Puberty_Q$stage==2.5),]
Allwaves_Puberty_Q <- Allwaves_Puberty_Q[!(Allwaves_Puberty_Q$tagid=="TAG124" & Allwaves_Puberty_Q$pdss==3 & Allwaves_Puberty_Q$stage==4),]
Allwaves_Puberty_Q$wave[Allwaves_Puberty_Q$tagid=="TAG124" & Allwaves_Puberty_Q$pdss==5 & Allwaves_Puberty_Q$stage==4] = 3
Allwaves_Puberty_Q$wave[Allwaves_Puberty_Q$tagid == "TAG001" &
Allwaves_Puberty_Q$pdss == 5 &
Allwaves_Puberty_Q$stage == 4.5] <- 5
Allwaves_Puberty_Q$wave[Allwaves_Puberty_Q$tagid == "TAG152" &
Allwaves_Puberty_Q$pdss == 5 &
Allwaves_Puberty_Q$stage == 5] <- 5
## age at w5 is also age at w1 so correcting based on w5, s2 date and dob
Allwaves_Puberty_Q$age[Allwaves_Puberty_Q$tagid == "TAG152" &
Allwaves_Puberty_Q$wave == 5] <- 17.1
## this calculation is wrong so removing this duplicate
Allwaves_Puberty_Q <- Allwaves_Puberty_Q[!(Allwaves_Puberty_Q$tagid=="TAG001" & Allwaves_Puberty_Q$pdss==5 & Allwaves_Puberty_Q$stage==2.5),]
Allwaves_Puberty_Q <- merge(Allwaves_Puberty_Q, Age, by=c("tagid","wave"), all.x=T) %>%
filter(tagid %in% overview$tagid)
###CREATE COMPOSITE ADRENAL AND GONADAL AND PUBERTAL SCORES FROM PDS & PBIP ######
#calculates mean of adrenal and gonadal composites that are mean of PBIP and PDS items,
PubertyComposite <- Allwaves_Puberty_Q %>%
mutate(ADRENdiff = adrenf2-PBIP_2A,
GONADdiff = gonadf2-PBIP_1A) %>%
rowwise %>%
mutate(ADRENcomp = mean(c(adrenf2,PBIP_2A),na.rm=T), #if only one measure (i.e. PDS or PBIP) is available, will use that instead of NA.
GONADcomp = mean(c(gonadf2,PBIP_1A),na.rm=T),
PUBcomp = mean(c(pdss, stage),na.rm=T))
PubertyMissing <- PubertyComposite %>% filter(is.na(PUBcomp))
View(PubertyComposite)
View(Allwaves_Puberty_Q)
Allwaves_Puberty_Q <- merge(Allwaves_Puberty_Q, Age, by=c("tagid","wave"), all.x=T) %>%
filter(tagid %in% overview$tagid) %>%
select(tagid, wave, adrenf2, PBIP_1A, PBIP_2A, gonadf2, pdss, stage, survey_date)
Allwaves_Puberty_Q <- left_join(PDS, PBIP,  by=c("tagid","wave"))
Allwaves_Puberty_Q <- Allwaves_Puberty_Q[!(Allwaves_Puberty_Q$tagid=="TAG077" & Allwaves_Puberty_Q$pdss==3.5 & Allwaves_Puberty_Q$stage==2),]
Allwaves_Puberty_Q <- Allwaves_Puberty_Q[!(Allwaves_Puberty_Q$tagid=="TAG077" & Allwaves_Puberty_Q$pdss==2 & Allwaves_Puberty_Q$stage==3),]
Allwaves_Puberty_Q$wave[Allwaves_Puberty_Q$tagid=="TAG077" & Allwaves_Puberty_Q$pdss==3.5 & Allwaves_Puberty_Q$stage==3] = 3
Allwaves_Puberty_Q <- Allwaves_Puberty_Q[!(Allwaves_Puberty_Q$tagid=="TAG124" & Allwaves_Puberty_Q$pdss==5 & Allwaves_Puberty_Q$stage==2.5),]
Allwaves_Puberty_Q <- Allwaves_Puberty_Q[!(Allwaves_Puberty_Q$tagid=="TAG124" & Allwaves_Puberty_Q$pdss==3 & Allwaves_Puberty_Q$stage==4),]
Allwaves_Puberty_Q$wave[Allwaves_Puberty_Q$tagid=="TAG124" & Allwaves_Puberty_Q$pdss==5 & Allwaves_Puberty_Q$stage==4] = 3
Allwaves_Puberty_Q$wave[Allwaves_Puberty_Q$tagid == "TAG001" &
Allwaves_Puberty_Q$pdss == 5 &
Allwaves_Puberty_Q$stage == 4.5] <- 5
Allwaves_Puberty_Q$wave[Allwaves_Puberty_Q$tagid == "TAG152" &
Allwaves_Puberty_Q$pdss == 5 &
Allwaves_Puberty_Q$stage == 5] <- 5
## age at w5 is also age at w1 so correcting based on w5, s2 date and dob
Allwaves_Puberty_Q$age[Allwaves_Puberty_Q$tagid == "TAG152" &
Allwaves_Puberty_Q$wave == 5] <- 17.1
## this calculation is wrong so removing this duplicate
Allwaves_Puberty_Q <- Allwaves_Puberty_Q[!(Allwaves_Puberty_Q$tagid=="TAG001" & Allwaves_Puberty_Q$pdss==5 & Allwaves_Puberty_Q$stage==2.5),]
Allwaves_Puberty_Q <- merge(Allwaves_Puberty_Q, Age, by=c("tagid","wave"), all.x=T) %>%
filter(tagid %in% overview$tagid) %>%
select(tagid, wave, adrenf2, PBIP_1A, PBIP_2A, gonadf2, pdss, stage, survey_date)
View(Allwaves_Puberty_Q)
Allwaves_Puberty_Q <- merge(Allwaves_Puberty_Q, Age, by=c("tagid","wave"), all.x=T) %>%
filter(tagid %in% overview$tagid) %>%
select(tagid, wave, adrenf2, PBIP_1A, PBIP_2A, gonadf2, pdss, stage, survey_date.x)
Allwaves_Puberty_Q <- merge(Allwaves_Puberty_Q, Age, by=c("tagid","wave"), all.x=T) %>%
filter(tagid %in% overview$tagid) %>%
select(tagid, wave, adrenf2, PBIP_1A, PBIP_2A, gonadf2, pdss, stage, survey_date.x) %>%
rename(survey_date = survery_date.x)
Allwaves_Puberty_Q <- merge(Allwaves_Puberty_Q, Age, by=c("tagid","wave"), all.x=T) %>%
filter(tagid %in% overview$tagid) %>%
select(tagid, wave, adrenf2, PBIP_1A, PBIP_2A, gonadf2, pdss, stage, survey_date.x) %>%
rename("survey_date" = "survery_date.x")
View(Allwaves_Puberty_Q)
###CREATE COMPOSITE ADRENAL AND GONADAL AND PUBERTAL SCORES FROM PDS & PBIP ######
#calculates mean of adrenal and gonadal composites that are mean of PBIP and PDS items,
PubertyComposite <- Allwaves_Puberty_Q %>%
mutate(ADRENdiff = adrenf2-PBIP_2A,
GONADdiff = gonadf2-PBIP_1A) %>%
rowwise %>%
mutate(ADRENcomp = mean(c(adrenf2,PBIP_2A),na.rm=T), #if only one measure (i.e. PDS or PBIP) is available, will use that instead of NA.
GONADcomp = mean(c(gonadf2,PBIP_1A),na.rm=T),
PUBcomp = mean(c(pdss, stage),na.rm=T))
View(Allwaves_Puberty_Q)
View(PubertyComposite)
View(Allwaves_Puberty_Q)
PubertyComposite <- left_join(PubertyComposite, age, by = c("tagid", "wave"))
PubertyComposite <- left_join(PubertyComposite, Age, by = c("tagid", "wave"))
View(PubertyComposite)
PubertyComposite <- left_join(PubertyComposite, Age, by = c("tagid", "wave")) %>%
select(-X)
PubertyComposite <- left_join(PubertyComposite, Age, by = c("tagid", "wave"))
###SAVE COMPOSITE SCORES ######
write.csv(PubertyComposite,paste0(proj_dir,'Allwaves_PubertyComposite_updated.csv'),row.names=F)
knitr::opts_chunk$set(
echo = TRUE,
message = TRUE,
warning = TRUE
)
options(scipen=999)
# load packages
library(pacman)
pacman::p_load(dplyr, lme4, nlme, ggplot2, tidyr, lubridate, psych, install = TRUE)
cas_dir = "/Volumes/psych-cog/dsnlab/TAG/"
proj_root = "/Volumes/psych-cog/dsnlab/TAG/projects/timing_tempo_tag/"
data_root = "/Volumes/psych-cog/dsnlab/TAG/behavior/Questionnaires/Long/"
# proj_root = "/Users/clarefmccann/University\ of\ Oregon\ Dropbox/Clare\ McCann/mine/projects/tag-projs/timing_tempo_tag/"
# data_root = "/Users/clarefmccann/University\ of\ Oregon\ Dropbox/Clare\ McCann/mine/projects/tag-projs/data-tag/"
## UPDATE FILE NAMES IF NEEDED
pds_file_name = "PDS_AllObs_Chronological.csv"
pbip_file_name = "PBIP_AllObs_Chronological.csv"
age_file_name = "allwaves_age_long_06.13.2025.csv"
pub_comp_file_name = "Allwaves_PubertyComposite_updated.csv"
## for puberty self-report variables
### LOAD IN PDS
pds <- read.csv(paste0(data_root, pds_file_name)) %>%
mutate(tagid=as.factor(tagid),
wave=as.factor(wave)) %>%
select(tagid, wave, adrenf2, gonadf2, pdss) %>%
rename("adrenal_pdss" = "adrenf2",
"gonadal_pdss" = "gonadf2")
### LOAD IN PBIP
pbip <- read.csv(paste0(data_root, pbip_file_name)) %>%
mutate(tagid=as.factor(tagid),
wave=as.factor(wave)) %>%
select(tagid, wave, stage, PBIP_1A, PBIP_2A) %>%
rename("adrenal_pbip" = "PBIP_2A",
"gonadal_pbip" = "PBIP_1A")
# pub_comp <- read.csv(paste0(data_root, pub_comp_file_name)) %>%
#   mutate(tagid=as.factor(tagid),
#          wave=as.factor(wave)) %>%
#   select(tagid, wave, ADRENcomp, GONADcomp, PUBcomp)
# age <- read.csv(paste0(cas_dir, "behavior/Demographics/", age_file_name)) %>%
#   pivot_longer(cols = 2:14, names_to = "wave", values_to = "age") %>%
#   # mutate(tagid=paste0("TAG",
#   #                     substring(tagid,first=5,last=length(tagid)))) %>%
#     filter(
#     !wave == "w1s1_age",
#     !wave == "w2s1_age",
#     !wave == "w3s1_age",
#     !wave == "w4s1_age",
#     !wave == "w5s1_age",
#     !wave == "w6s1_age"
#   ) %>%
#   mutate(
#     wave = ifelse(wave == "w1s2_age", "1",
#                   ifelse(wave == "w2s2_age", "2",
#                          ifelse(wave == "w3s2_age", "3",
#                                 ifelse(wave == "w4s2_age", "4",
#                                        ifelse(wave == "w5s2_age", "5",
#                                               ifelse(wave == "w6s2_age", "6",
#                                                      ifelse(wave == "sos_age", "SOS",
#                                               wave)))))))) %>%
#   filter(!is.na(age))
age <- read.csv(paste0(cas_dir, "behavior/Demographics/", age_file_name))
puberty_sr <- left_join(pds, pbip, by = c("tagid", "wave"))
#puberty_sr <- left_join(puberty_sr, pub_comp, by = c("tagid", "wave"))
puberty_sr <- left_join(puberty_sr, age, by = c("tagid", "wave"))
### choose what variables you want to use
set.seed(90025)
print("interpretation of values: lambda is timing (or age at peak growth / TS3), alpha is tempo (or rate of change)")
print("smaller or more negative values for for lambda = earlier timing, positive or larger values for alpha = faster tempo")
puberty_vars <- c("pdss", "stage", "adrenal_pbip", "PUBComp","GonadalComp", "gonadal_pbip")
## model does not converge with PDSS or PUBcomp adrenal scores, or PDSS gonadal score
# logistic model with random effects
logistic_model <- function(age, b0, b1, alpha, lambda) {
b0 + (b1 - b0) * (1 / (1 + exp(-alpha * (age - lambda))))
}
start_vals <- list(fixed = c(alpha = 0.95, lambda = 13.1))
results_list <- list()
for (var in puberty_vars) {
print(paste0("fitting model for: ", var))
puberty_sr_tmp <- puberty_sr %>%
rename(puberty = !!sym(var)) %>%
filter(!is.na(puberty) & !is.na(age) & !is.na(tagid))
fit <- nlme(puberty ~ logistic_model(age, 1, 5, alpha, lambda),
data = puberty_sr_tmp,
fixed = alpha + lambda ~ 1,
random = pdDiag(alpha + lambda ~ 1),
groups = ~ tagid,
start = start_vals,
method = "ML")
fitted_values <- fitted(fit)
individual_estimates <- ranef(fit)
individual_estimates_df <- data.frame(id = rownames(individual_estimates), individual_estimates) %>%
rename("tagid" = "id")
puberty_plot <- cbind(fitted_values, puberty_sr_tmp)
puberty_plot <- left_join(puberty_plot, individual_estimates_df, by = "tagid")
fitted_values_plot <- ggplot(data = puberty_plot, aes(x = age, y = fitted_values, color = tagid)) +
geom_point(aes(y = fitted_values), size = 1, shape = 16) +
geom_line(aes(y = fitted_values), size = 0.5, linetype = "solid") +
labs(
title = paste("predicted values -", var),
x = "age",
y = "predicted pubertal stage",
color = "tagid"
) +
theme_minimal() +
theme(legend.position = "none")
print(paste0("printing fitted values plot for", var))
print(fitted_values_plot)
results_list[[var]] <- list(
fit = fit,
fitted_values = fitted_values,
individual_estimates = individual_estimates,
plot = fitted_values_plot
)
# write.csv(puberty_wide, paste0("puberty_wide_", var, ".csv"))
# write.csv(puberty_plot, paste0("puberty_plot_", var, ".csv"))
}
View(puberty_sr)
## for puberty self-report variables
### LOAD IN PDS
pds <- read.csv(paste0(data_root, pds_file_name)) %>%
mutate(tagid=as.factor(tagid),
wave=as.factor(wave)) %>%
select(tagid, wave, adrenf2, gonadf2, pdss) %>%
rename("adrenal_pdss" = "adrenf2",
"gonadal_pdss" = "gonadf2")
### LOAD IN PBIP
pbip <- read.csv(paste0(data_root, pbip_file_name)) %>%
mutate(tagid=as.factor(tagid),
wave=as.factor(wave)) %>%
select(tagid, wave, stage, PBIP_1A, PBIP_2A) %>%
rename("adrenal_pbip" = "PBIP_2A",
"gonadal_pbip" = "PBIP_1A")
pub_comp <- read.csv(paste0(data_root, pub_comp_file_name)) %>%
mutate(tagid=as.factor(tagid),
wave=as.factor(wave)) %>%
select(tagid, wave, ADRENcomp, GONADcomp, PUBcomp)
# age <- read.csv(paste0(cas_dir, "behavior/Demographics/", age_file_name)) %>%
#   pivot_longer(cols = 2:14, names_to = "wave", values_to = "age") %>%
#   # mutate(tagid=paste0("TAG",
#   #                     substring(tagid,first=5,last=length(tagid)))) %>%
#     filter(
#     !wave == "w1s1_age",
#     !wave == "w2s1_age",
#     !wave == "w3s1_age",
#     !wave == "w4s1_age",
#     !wave == "w5s1_age",
#     !wave == "w6s1_age"
#   ) %>%
#   mutate(
#     wave = ifelse(wave == "w1s2_age", "1",
#                   ifelse(wave == "w2s2_age", "2",
#                          ifelse(wave == "w3s2_age", "3",
#                                 ifelse(wave == "w4s2_age", "4",
#                                        ifelse(wave == "w5s2_age", "5",
#                                               ifelse(wave == "w6s2_age", "6",
#                                                      ifelse(wave == "sos_age", "SOS",
#                                               wave)))))))) %>%
#   filter(!is.na(age))
age <- read.csv(paste0(cas_dir, "behavior/Demographics/", age_file_name))
puberty_sr <- left_join(pds, pbip, by = c("tagid", "wave"))
puberty_sr <- left_join(puberty_sr, pub_comp, by = c("tagid", "wave"))
puberty_sr <- left_join(puberty_sr, age, by = c("tagid", "wave"))
### choose what variables you want to use
set.seed(90025)
print("interpretation of values: lambda is timing (or age at peak growth / TS3), alpha is tempo (or rate of change)")
print("smaller or more negative values for for lambda = earlier timing, positive or larger values for alpha = faster tempo")
puberty_vars <- c("pdss", "stage", "adrenal_pbip", "PUBComp","GonadalComp", "gonadal_pbip")
## model does not converge with PDSS or PUBcomp adrenal scores, or PDSS gonadal score
# logistic model with random effects
logistic_model <- function(age, b0, b1, alpha, lambda) {
b0 + (b1 - b0) * (1 / (1 + exp(-alpha * (age - lambda))))
}
start_vals <- list(fixed = c(alpha = 0.95, lambda = 13.1))
results_list <- list()
for (var in puberty_vars) {
print(paste0("fitting model for: ", var))
puberty_sr_tmp <- puberty_sr %>%
rename(puberty = !!sym(var)) %>%
filter(!is.na(puberty) & !is.na(age) & !is.na(tagid))
fit <- nlme(puberty ~ logistic_model(age, 1, 5, alpha, lambda),
data = puberty_sr_tmp,
fixed = alpha + lambda ~ 1,
random = pdDiag(alpha + lambda ~ 1),
groups = ~ tagid,
start = start_vals,
method = "ML")
fitted_values <- fitted(fit)
individual_estimates <- ranef(fit)
individual_estimates_df <- data.frame(id = rownames(individual_estimates), individual_estimates) %>%
rename("tagid" = "id")
puberty_plot <- cbind(fitted_values, puberty_sr_tmp)
puberty_plot <- left_join(puberty_plot, individual_estimates_df, by = "tagid")
fitted_values_plot <- ggplot(data = puberty_plot, aes(x = age, y = fitted_values, color = tagid)) +
geom_point(aes(y = fitted_values), size = 1, shape = 16) +
geom_line(aes(y = fitted_values), size = 0.5, linetype = "solid") +
labs(
title = paste("predicted values -", var),
x = "age",
y = "predicted pubertal stage",
color = "tagid"
) +
theme_minimal() +
theme(legend.position = "none")
print(paste0("printing fitted values plot for", var))
print(fitted_values_plot)
results_list[[var]] <- list(
fit = fit,
fitted_values = fitted_values,
individual_estimates = individual_estimates,
plot = fitted_values_plot
)
# write.csv(puberty_wide, paste0("puberty_wide_", var, ".csv"))
# write.csv(puberty_plot, paste0("puberty_plot_", var, ".csv"))
}
View(puberty_sr)
### choose what variables you want to use
set.seed(90025)
print("interpretation of values: lambda is timing (or age at peak growth / TS3), alpha is tempo (or rate of change)")
print("smaller or more negative values for for lambda = earlier timing, positive or larger values for alpha = faster tempo")
puberty_vars <- c("pdss", "stage", "adrenal_pbip", "PUBcomp","GONADcomp", "gonadal_pbip")
## model does not converge with PDSS or PUBcomp adrenal scores, or PDSS gonadal score
# logistic model with random effects
logistic_model <- function(age, b0, b1, alpha, lambda) {
b0 + (b1 - b0) * (1 / (1 + exp(-alpha * (age - lambda))))
}
start_vals <- list(fixed = c(alpha = 0.95, lambda = 13.1))
results_list <- list()
for (var in puberty_vars) {
print(paste0("fitting model for: ", var))
puberty_sr_tmp <- puberty_sr %>%
rename(puberty = !!sym(var)) %>%
filter(!is.na(puberty) & !is.na(age) & !is.na(tagid))
fit <- nlme(puberty ~ logistic_model(age, 1, 5, alpha, lambda),
data = puberty_sr_tmp,
fixed = alpha + lambda ~ 1,
random = pdDiag(alpha + lambda ~ 1),
groups = ~ tagid,
start = start_vals,
method = "ML")
fitted_values <- fitted(fit)
individual_estimates <- ranef(fit)
individual_estimates_df <- data.frame(id = rownames(individual_estimates), individual_estimates) %>%
rename("tagid" = "id")
puberty_plot <- cbind(fitted_values, puberty_sr_tmp)
puberty_plot <- left_join(puberty_plot, individual_estimates_df, by = "tagid")
fitted_values_plot <- ggplot(data = puberty_plot, aes(x = age, y = fitted_values, color = tagid)) +
geom_point(aes(y = fitted_values), size = 1, shape = 16) +
geom_line(aes(y = fitted_values), size = 0.5, linetype = "solid") +
labs(
title = paste("predicted values -", var),
x = "age",
y = "predicted pubertal stage",
color = "tagid"
) +
theme_minimal() +
theme(legend.position = "none")
print(paste0("printing fitted values plot for", var))
print(fitted_values_plot)
results_list[[var]] <- list(
fit = fit,
fitted_values = fitted_values,
individual_estimates = individual_estimates,
plot = fitted_values_plot
)
# write.csv(puberty_wide, paste0("puberty_wide_", var, ".csv"))
# write.csv(puberty_plot, paste0("puberty_plot_", var, ".csv"))
}
all_estimates <- NULL
for (var in names(results_list)) {
estimates <- results_list[[var]]$individual_estimates
estimates_df <- data.frame(tagid = rownames(estimates), estimates, row.names = NULL)
colnames(estimates_df)[-1] <- paste0(var, "_", colnames(estimates_df)[-1])
if (is.null(all_estimates)) {
all_estimates <- estimates_df
} else {
all_estimates <- full_join(all_estimates, estimates_df, by = "tagid")
}
}
write.csv(all_estimates, paste0(proj_root, "TAG_timing_tempo_04.2025.csv"), row.names = FALSE)
View(fit)
View(results_list)
results_list[["PUBcomp"]][["fit"]]
View(results_list)
results_list[["GONADcomp"]][["fit"]]
regressing_ids <- puberty_sr %>%
arrange(tagid, wave) %>%
group_by(tagid) %>%
mutate(stage_diff = stage - lag(stage)) %>%
filter(stage_diff < 0) %>%
select(id) %>%
distinct()
regressing_ids <- puberty_sr %>%
arrange(tagid, wave) %>%
group_by(tagid) %>%
mutate(stage_diff = stage - lag(stage)) %>%
filter(stage_diff < 0) %>%
select(tagid) %>%
distinct()
View(regressing_ids)
View(puberty_sr)
knitr::opts_chunk$set(
echo = TRUE,
message = TRUE,
warning = TRUE
)
options(scipen=999)
# load packages
library(pacman)
pacman::p_load(dplyr, lme4, nlme, readxl, ggplot2, tidyr, lubridate, psych, install = TRUE)
cas_dir = "/Volumes/psych-cog/dsnlab/TAG/"
proj_root = "/Volumes/psych-cog/dsnlab/TAG/projects/immune/"
data_root = "/Volumes/psych-cog/dsnlab/TAG/behavior/Immune/"
## UPDATE FILE NAMES IF NEEDED
# puberty
pds <- read.csv(paste0(cas_dir, "data/Qualtrics_Output/Long/PDS_AllObs_Chronological.csv")) %>%
mutate(tagid=as.factor(tagid),
wave=as.factor(wave)) %>%
select(tagid, wave, adrenf2, gonadf2, pdss) %>%
rename("adrenal_pdss" = "adrenf2",
"gonadal_pdss" = "gonadf2")
# age
age <- read.csv(paste0(cas_dir, "data/Demographics/allwaves_age_long_06.13.2025.csv"))
######## HORMONES #############
be_w1w2_hormones <- read.csv(paste0(cas_dir, "data/Puberty/Saliva/TAG_W1W2_Saliva_basalestimates.csv")) %>%
pivot_longer(2:3, names_to = "hormone_w1", values_to = "level_w1") %>%
pivot_longer(9:11, names_to = "hormone_w2", values_to = "level_w2") %>%
select(SID, hormone_w1, level_w1, hormone_w2, level_w2) %>%
separate(hormone_w1, into = c("hormone_w1", "wave_w1"), sep = "_(?=wave)") %>%
separate(hormone_w2, into = c("hormone_w2", "wave_w2"), sep = "_(?=wave)") %>%
pivot_longer(
cols = c(hormone_w1, wave_w1, level_w1, hormone_w2, wave_w2, level_w2),
names_to = c(".value", "timepoint"),
names_pattern = "(.*)_(w[12])"
) %>%
distinct() %>%
select(SID, wave, hormone, level) %>%
mutate(SID = sprintf("TAG_%03d", SID),
hormone = ifelse(hormone == "TESTmean", "testosterone_mean",
ifelse(hormone == "ESTmean", "estradiol_mean",
ifelse(hormone == "DHEAmean", "DHEA_mean",
hormone)))) %>%
rename("tagid" = "SID")
be_w3_hormones <- read.csv(paste0("/Volumes/psych-cog/dsnlab/cjm/hormones_wm/hormone_cleaning/W3_basal_estimates_flux.csv")) %>%
pivot_longer(2:4, names_to = "hormone", values_to = "level") %>%
select(tagid, hormone, level) %>%
mutate(wave = "wave3")
be_w4_hormones <- read.csv(paste0("/Volumes/psych-cog/dsnlab/cjm/hormones_wm/hormone_cleaning/W4_basal_estimates_flux.csv")) %>%
pivot_longer(2:4, names_to = "hormone", values_to = "level") %>%
select(tagid, hormone, level) %>%
mutate(wave = "wave4")
be_w5_hormones <- read.csv(paste0("/Volumes/psych-cog/dsnlab/cjm/hormones_wm/hormone_cleaning/W5_basal_estimates_flux.csv")) %>%
pivot_longer(2:4, names_to = "hormone", values_to = "level") %>%
select(tagid, hormone, level) %>%
mutate(wave = "wave5")
#c_sos_hormones <- read.csv(paste0(cas_dir, "behavior/SOS/saliva/Cleaned_datasets/SOS_hormones_cleaned.csv"))
be_hormones <- full_join(be_w1w2_hormones, full_join(be_w3_hormones, full_join(be_w4_hormones, be_w5_hormones)))
age <- age %>%
mutate(
tagid = sub("^(TAG)(\\d+)", "TAG_\\2", tagid),
wave = ifelse(wave == 1, "wave1",
ifelse(wave == 2, "wave2",
ifelse(wave == 3, "wave3",
ifelse(wave == 4, "wave4",
ifelse(wave == 5, "wave5", wave)))))
)
pds <- pds %>%
mutate(
tagid = sub("^(TAG)(\\d+)", "TAG_\\2", tagid),
wave = ifelse(wave == 1, "wave1",
ifelse(wave == 2, "wave2",
ifelse(wave == 3, "wave3",
ifelse(wave == 4, "wave4",
ifelse(wave == 5, "wave5", wave)))))
)
be_hormones <- left_join(be_hormones, age, by = c("tagid", "wave"))
be_hormones <- left_join(be_hormones, pds, by = c("tagid", "wave"))
View(be_hormones)
